networks:
  limport-network:
    external: true
  tms-local:
    driver: bridge

services:
  # TMS Application
  # tms-app:
  #   build: .    # Assuming Dockerfile is in the current directory, build the image locally 
  #   container_name: limport-tms
  #   depends_on:
  #     tms-postgres:
  #       condition: service_healthy
  #     tms-redis:
  #       condition: service_healthy
  #   networks:
  #     - limport-network  # Connect to shared infrastructure
  #     - tms-local        # Connect to local services
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     SPRING_PROFILES_ACTIVE: docker
  #     SPRING_DATASOURCE_URL: jdbc:postgresql://tms-postgres:5432/tms_db
  #     REDIS_HOST: tms-redis
  #     EVENT_TRACKER_TYPE: redis  # Use Redis for production idempotency
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092  # From shared network

  # TMS Database (dedicated)
  tms-postgres:
    image: postgres:15-alpine
    container_name: limport-tms-postgres
    environment:
      POSTGRES_DB: tms_db
      POSTGRES_USER: tms_user
      POSTGRES_PASSWORD: tms_password
    networks:
      - tms-local
    ports:
      - "5434:5432"  # Different port to avoid conflicts with NS
    volumes:
      - tms-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tms_user -d tms_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # TMS Redis (for event idempotency tracking and caching)
  tms-redis:
    image: redis:7-alpine
    container_name: limport-tms-redis
    networks:
      - tms-local
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    volumes:
      - tms-redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # TMS Database Admin (optional)
  tms-adminer:
    image: adminer
    container_name: limport-tms-adminer
    depends_on:
      tms-postgres:
        condition: service_healthy
    networks:
      - tms-local
    ports:
      - "8082:8080"
    environment:
      ADMINER_DEFAULT_SERVER: tms-postgres

volumes:
  tms-postgres-data:
  tms-redis-data: